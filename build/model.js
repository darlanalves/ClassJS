/*
 WhappJS
 Built on 2013-04-09
*/

(function(){"use strict";Whapp.namespace("Whapp.data"),Whapp.data.Types={register:function(t,n){Whapp.data.types[t]=n},date:{convert:function(t){return t?_.isDate(t)?t:new Date(t):null}},timestamp:{convert:function(t){return new Date(1e3*t)}},time:{convert:function(t){return new Date(parseInt(t,10))}},bool:{convert:function(t){return Boolean(t)}},"int":{convert:function(t){return void 0!==t&&null!==t&&""!==t?parseInt(t.replace(/\D+/,""),10):null}},"float":{convert:function(t){return void 0!==t&&null!==t&&""!==t?parseInt(t.replace(/\D+/,""),10):null}},number:{convert:function(t){return Number(t)}},model:{convert:function(t){return t.toJSON?t.toJSON():null}},auto:{convert:function(t){return t}}}}).call(this),function(){var t=Whapp.data.Types;Whapp.define("Whapp.data.Field",{name:"",constructor:function(t){_.isString(t)&&(t={name:t}),_.extend(this,t)},getValueOf:function(t){return _.isFunction(this.convert)?this.convert(t):this.$convert(t)},$convert:function(n){var e=this.type||"auto";return t[e]?t[e].convert.call(this,n):n}})}.call(this),function(){"use strict";var t=({}.hasOwnProperty,this.Class.uuid,Whapp.data.Field);Whapp.define("Whapp.data.Model",{extend:"Whapp.Component",dirty:!1,modified:null,constructor:function(t){this.data=t,this.modified={},this.mapFields(),this.setData(t,1)},isDirty:function(){return this.dirty},isNew:function(){return null===this.$data.id},getChanges:function(){return this.modified},getRawData:function(){return this.data},getData:function(){return this.$data},setData:function(t,n){var e={};n=void 0!==n?!!n:!1,_.each(this.$fields,function(n,i){e[i]=n.getValueOf(t[i]||null)}),this.$data=e,n||this.trigger("update",this.$data)},get:function(t){return void 0!==this.$data[t]?this.$data[t]:null},set:function(t,n){this.$fields[t]&&(this.data[t]=n,this.$data=this.$fields[t].getValueOf(n));var e={};return e[t]=n,_.extend(this.modified,e),this.dirty=!0,this.trigger("update",e),this},revert:function(){this.modified={},this.dirty=!1,this.trigger("revert",this)},commit:function(){0!=this.dirty&&(this.trigger("commit",this.modified,this),_.extend(this.data,this.modified),this.setData(this.modified),this.revert())},edit:function(){this.dirty=!0},toJSON:function(){return e(this.getData())},mapFields:function(){var n=this.mapping,e=this;this.fields||(this.fields=[]),n&&_.isArray(n)&&_.each(n,function(t){var n=Whapp.ClassManager.resolve(t.model),i=t.name;_.isFunction(n)&&i&&e.fields.push({name:i,type:"model",convert:function(t){if(_.isArray(t)){var e,i,s;for(e=[],i=0,s=t.length;s>i;i++)e.push(new n(t[i]))}else e=new n(t);return e}})});var i=this.fields;this.$fields={},_.isArray(i)&&_.each(i,function(n){e.$fields[n.name]=new t(n)})}});var n=function(t,e){var i,s;for(i in t)if(t.hasOwnProperty(i))if(s=t[i],s===Object(s)&&s instanceof Whapp.data.Model){var r=n(s.getData(),{});for(var a in r)r.hasOwnProperty(a)&&(e[i]||(e[i]={}),e[i][a]=r[a])}else e[i]=s;return e},e=function(t){return n(t,{})}}.call(Whapp);